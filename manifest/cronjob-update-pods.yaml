apiVersion: batch/v1
kind: CronJob
metadata:
  name: update-pods-md
  namespace: prod
spec:
  schedule: "0 */3 * * *"  # Run every 3 hour for more dynamic updates
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 1  # Limit retries to 1 attempt
      template:
        spec:
          containers:
          - name: update-pods
            image: bitnami/git:latest  # Changed to git-based image
            env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-token-secret
                  key: GITHUB_TOKEN
            - name: GIT_USERNAME
              value: "zoonderkins"
            - name: GIT_EMAIL
              value: "git-ed@runbox.no"
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # Install required tools 
              apt-get update && apt-get install -y curl jq
              
              # Install kubectl directly from Kubernetes
              echo "Installing kubectl..."
              KUBE_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt)
              curl -LO "https://dl.k8s.io/release/${KUBE_VERSION}/bin/linux/amd64/kubectl"
              chmod +x ./kubectl
              mv ./kubectl /usr/local/bin/kubectl
              
              # Verify kubectl installation
              kubectl version --client
              
              # Debug token - print first few characters (safely)
              echo "GitHub token length: ${#GITHUB_TOKEN}"
              echo "Token prefix: ${GITHUB_TOKEN:0:4}..."
              
              # Clone the repository
              echo "Cloning repository..."
              REPO_DIR="/tmp/repo"
              git clone "https://${GIT_USERNAME}:${GITHUB_TOKEN}@github.com/zoonderkins/edoo-k8s-demo-site.git" "${REPO_DIR}"
              
              # Configure git (inside repo directory)
              cd "${REPO_DIR}"
              git config --global user.email "${GIT_EMAIL}"
              git config --global user.name "${GIT_USERNAME}"
              
              # Create a simple update script directly in the script
              echo "Fetching pod information..."
              mkdir -p content static/api static/css static/js
              
              # Ensure custom directories exist and are not modified
              echo "Ensuring custom content directories..."
              mkdir -p static/css/custom static/js/custom
              
              # Create a .gitkeep file if the directories are empty
              touch static/css/custom/.gitkeep static/js/custom/.gitkeep
              
              # Get actual pod information
              echo "Getting pod information..."
              # Get pod data - Format: POD_NAME NAMESPACE STATUS NODE
              POD_INFO=$(kubectl get pods --all-namespaces -o=custom-columns=NAME:.metadata.name,NAMESPACE:.metadata.namespace,STATUS:.status.phase,NODE:.spec.nodeName --no-headers | sort -b -k2)
              
              # Calculate pod totals
              TOTAL_PODS=$(echo "$POD_INFO" | wc -l | tr -d ' ')
              RUNNING_PODS=$(echo "$POD_INFO" | grep -c "Running" || echo "0")
              CURRENT_DATE=$(date -Iseconds)
              
              # Get current pod's worker node
              WORKER_NODE=$(kubectl get pod -o jsonpath="{.spec.nodeName}" -n ${POD_NAMESPACE} ${HOSTNAME} 2>/dev/null || echo "unknown-worker")
              echo "Current worker node: ${WORKER_NODE}"
              
              # Get GitHub commit hash - use webhook SHA if available or current git hash
              if [ -n "${GITHUB_SHA}" ]; then
                GIT_HASH="${GITHUB_SHA:0:7}"
              else
                GIT_HASH=$(git rev-parse --short HEAD)
              fi
              
              # Format date in CST timezone instead of UTC
              # First make sure the tzdata package is installed
              if ! dpkg -l | grep -q tzdata; then
                apt-get update && apt-get install -y tzdata
              fi
              
              # Set timezone to CST and format date - force update with current time
              export TZ="America/Chicago"
              FORMATTED_DATE=$(date "+%Y-%m-%d %H:%M:%S CST")
              
              # Update _index.md directly with pod data instead of creating a separate pods.md
              if [ -f "content/_index.md" ]; then
                echo "Updating content in _index.md..."
                
                # Create a completely clean version of the file to work with
                TMP_INDEX="/tmp/clean_index.md"
                
                # Extract frontmatter (everything from start until the second ---)
                sed -n '1,/^---$/p' content/_index.md > "${TMP_INDEX}"
                
                # Update date field in frontmatter
                sed -i "s/^date: .*$/date: ${CURRENT_DATE}/" "${TMP_INDEX}"
                
                # Add a blank line after frontmatter
                echo "" >> "${TMP_INDEX}"
                
                # Add the main title and header content
                echo "# K8s Production Cluster" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                echo "<div class=\"container\">" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                echo "<div class=\"node-info\">" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                echo "Worker node: <strong id=\"worker-node-name\">${WORKER_NODE}</strong><br>" >> "${TMP_INDEX}"
                echo "<span style=\"color: white\">Cluster Status: <strong id=\"index-cluster-status\">Healthy</strong>" >> "${TMP_INDEX}"
                echo "<br>" >> "${TMP_INDEX}"
                echo "Total Pods: <strong id=\"index-total-pods\">${TOTAL_PODS}</strong>" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                echo "Repository: <a href=\"https://github.com/zoonderkins/edoo-k8s-demo-site\" target=\"_blank\">https://github.com/zoonderkins/edoo-k8s-demo-site</a>" >> "${TMP_INDEX}"
                echo "</div>" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                
                # Add last update section with current timestamp and git hash
                echo "<div class=\"last-update\">" >> "${TMP_INDEX}"
                echo "Last update: <span id=\"last-update-time\">${FORMATTED_DATE}</span><br>" >> "${TMP_INDEX}"
                echo "Hash: <span class=\"commit-hash\" id=\"git-commit-hash\">${GIT_HASH}</span>" >> "${TMP_INDEX}"
                echo "</div>" >> "${TMP_INDEX}"
                echo "" >> "${TMP_INDEX}"
                
                # Add the kubernetes pods section header
                echo "### Kubernetes Pods" >> "${TMP_INDEX}"
                echo "<div class=\"table-container\">" >> "${TMP_INDEX}"
                
                # Add ONLY ONE table tag - this is the key fix
                echo '<table class="pod-table" id="summary-table">' >> "${TMP_INDEX}"
                echo '  <thead>' >> "${TMP_INDEX}"
                echo '      <tr>' >> "${TMP_INDEX}"
                echo '          <th>Pod Name</th>' >> "${TMP_INDEX}"
                echo '          <th>Namespace</th>' >> "${TMP_INDEX}"
                echo '          <th>Status</th>' >> "${TMP_INDEX}"
                echo '          <th>Node</th>' >> "${TMP_INDEX}"
                echo '      </tr>' >> "${TMP_INDEX}"
                echo '  </thead>' >> "${TMP_INDEX}"
                echo '  <tbody>' >> "${TMP_INDEX}"
                
                # Add pod data from POD_INFO - use a temporary file to avoid subshell issues
                echo "$POD_INFO" > /tmp/pod_data.txt
                while read -r POD_NAME NAMESPACE STATUS NODE; do
                  # Skip empty lines
                  [ -z "$POD_NAME" ] && continue
                  
                  echo "      <tr>" >> "${TMP_INDEX}"
                  echo "          <td>${POD_NAME}</td>" >> "${TMP_INDEX}"
                  echo "          <td>${NAMESPACE}</td>" >> "${TMP_INDEX}"
                  
                  # Add status with appropriate class
                  if [[ "$STATUS" == "Running" ]]; then
                    echo "          <td class=\"status-running\">${STATUS}</td>" >> "${TMP_INDEX}"
                  elif [[ "$STATUS" == "Pending" ]]; then
                    echo "          <td class=\"status-pending\">${STATUS}</td>" >> "${TMP_INDEX}"
                  elif [[ "$STATUS" == "Failed" || "$STATUS" == "Error" ]]; then
                    echo "          <td class=\"status-error\">${STATUS}</td>" >> "${TMP_INDEX}"
                  else
                    echo "          <td>${STATUS}</td>" >> "${TMP_INDEX}"
                  fi
                  
                  echo "          <td>${NODE}</td>" >> "${TMP_INDEX}"
                  echo "      </tr>" >> "${TMP_INDEX}"
                done < /tmp/pod_data.txt
                
                # Clean up temp file
                rm -f /tmp/pod_data.txt
                
                # Close the table
                echo '  </tbody>' >> "${TMP_INDEX}"
                echo '</table>' >> "${TMP_INDEX}"
                echo '</div>' >> "${TMP_INDEX}"
                echo '</div>' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                
                # Add the comprehensive responsive CSS styles
                echo '<style>' >> "${TMP_INDEX}"
                echo ':root {' >> "${TMP_INDEX}"
                echo '  --neon-green: #0f0;' >> "${TMP_INDEX}"
                echo '  --neon-pink: #ff69b4;' >> "${TMP_INDEX}"
                echo '  --cyber-purple: #9370db;' >> "${TMP_INDEX}"
                echo '  --matrix-black: #000;' >> "${TMP_INDEX}"
                echo '  --cyber-blue: #00ffff;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '* { box-sizing: border-box; }' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo 'body {' >> "${TMP_INDEX}"
                echo '  margin: 0;' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  font-family: "Courier New", monospace;' >> "${TMP_INDEX}"
                echo '  cursor: crosshair;' >> "${TMP_INDEX}"
                echo '  line-height: 1.6;' >> "${TMP_INDEX}"
                echo '  padding: 20px;' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '  overflow-x: auto;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Scanline effect */' >> "${TMP_INDEX}"
                echo 'body::before {' >> "${TMP_INDEX}"
                echo '  content: "";' >> "${TMP_INDEX}"
                echo '  position: fixed;' >> "${TMP_INDEX}"
                echo '  top: 0;' >> "${TMP_INDEX}"
                echo '  left: 0;' >> "${TMP_INDEX}"
                echo '  width: 100%;' >> "${TMP_INDEX}"
                echo '  height: 100%;' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(to bottom,' >> "${TMP_INDEX}"
                echo '    rgba(255,255,255,0) 0%,' >> "${TMP_INDEX}"
                echo '    rgba(0,255,0,0.03) 50%,' >> "${TMP_INDEX}"
                echo '    rgba(255,255,255,0) 100%);' >> "${TMP_INDEX}"
                echo '  animation: scan 8s linear infinite;' >> "${TMP_INDEX}"
                echo '  pointer-events: none;' >> "${TMP_INDEX}"
                echo '  z-index: 1000;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes scan {' >> "${TMP_INDEX}"
                echo '  0% { transform: translateY(-100vh); }' >> "${TMP_INDEX}"
                echo '  100% { transform: translateY(100vh); }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.container {' >> "${TMP_INDEX}"
                echo '  max-width: 1200px;' >> "${TMP_INDEX}"
                echo '  margin: 0 auto;' >> "${TMP_INDEX}"
                echo '  background: rgba(0, 0, 0, 0.95);' >> "${TMP_INDEX}"
                echo '  padding: 30px;' >> "${TMP_INDEX}"
                echo '  border: 2px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '  border-radius: 0;' >> "${TMP_INDEX}"
                echo '  box-shadow:' >> "${TMP_INDEX}"
                echo '    0 0 20px var(--neon-green),' >> "${TMP_INDEX}"
                echo '    inset 0 0 20px rgba(0, 255, 0, 0.1);' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.container::before {' >> "${TMP_INDEX}"
                echo '  content: "";' >> "${TMP_INDEX}"
                echo '  position: absolute;' >> "${TMP_INDEX}"
                echo '  top: -2px;' >> "${TMP_INDEX}"
                echo '  left: -2px;' >> "${TMP_INDEX}"
                echo '  right: -2px;' >> "${TMP_INDEX}"
                echo '  bottom: -2px;' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(45deg, var(--neon-green), var(--cyber-purple), var(--neon-pink), var(--cyber-blue));' >> "${TMP_INDEX}"
                echo '  z-index: -1;' >> "${TMP_INDEX}"
                echo '  animation: border-glow 3s ease-in-out infinite alternate;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes border-glow {' >> "${TMP_INDEX}"
                echo '  0% { opacity: 0.5; }' >> "${TMP_INDEX}"
                echo '  100% { opacity: 1; }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo 'h1 {' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  margin-bottom: 30px;' >> "${TMP_INDEX}"
                echo '  font-size: 2.5rem;' >> "${TMP_INDEX}"
                echo '  text-align: center;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 3px;' >> "${TMP_INDEX}"
                echo '  animation: glitch-title 2s infinite;' >> "${TMP_INDEX}"
                echo '  text-shadow:' >> "${TMP_INDEX}"
                echo '    2px 2px var(--neon-pink),' >> "${TMP_INDEX}"
                echo '    -2px -2px var(--cyber-purple),' >> "${TMP_INDEX}"
                echo '    0 0 10px var(--neon-green);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes glitch-title {' >> "${TMP_INDEX}"
                echo '  0% { transform: skew(0deg); }' >> "${TMP_INDEX}"
                echo '  20% { transform: skew(2deg); filter: hue-rotate(0deg); }' >> "${TMP_INDEX}"
                echo '  40% { transform: skew(-2deg); filter: hue-rotate(90deg); }' >> "${TMP_INDEX}"
                echo '  60% { transform: skew(2deg); filter: hue-rotate(180deg); }' >> "${TMP_INDEX}"
                echo '  80% { transform: skew(-2deg); filter: hue-rotate(270deg); }' >> "${TMP_INDEX}"
                echo '  100% { transform: skew(0deg); filter: hue-rotate(360deg); }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo 'h3 {' >> "${TMP_INDEX}"
                echo '  color: var(--cyber-purple);' >> "${TMP_INDEX}"
                echo '  margin-top: 30px;' >> "${TMP_INDEX}"
                echo '  margin-bottom: 15px;' >> "${TMP_INDEX}"
                echo '  font-size: 1.5rem;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 2px;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 10px var(--cyber-purple);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.node-info {' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(135deg,' >> "${TMP_INDEX}"
                echo '    rgba(147, 112, 219, 0.3) 0%,' >> "${TMP_INDEX}"
                echo '    rgba(255, 105, 180, 0.3) 50%,' >> "${TMP_INDEX}"
                echo '    rgba(0, 255, 255, 0.3) 100%);' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  padding: 25px;' >> "${TMP_INDEX}"
                echo '  border: 2px solid var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  margin-bottom: 25px;' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '  animation: info-pulse 4s infinite;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 5px currentColor;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes info-pulse {' >> "${TMP_INDEX}"
                echo '  0% { box-shadow: 0 0 10px var(--neon-pink); }' >> "${TMP_INDEX}"
                echo '  50% { box-shadow: 0 0 30px var(--cyber-purple), 0 0 40px var(--neon-pink); }' >> "${TMP_INDEX}"
                echo '  100% { box-shadow: 0 0 10px var(--neon-pink); }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.node-info::before {' >> "${TMP_INDEX}"
                echo '  content: "> SYSTEM STATUS";' >> "${TMP_INDEX}"
                echo '  position: absolute;' >> "${TMP_INDEX}"
                echo '  top: -12px;' >> "${TMP_INDEX}"
                echo '  left: 20px;' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  color: var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  padding: 0 10px;' >> "${TMP_INDEX}"
                echo '  font-size: 0.8rem;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.node-info a {' >> "${TMP_INDEX}"
                echo '  color: var(--cyber-blue);' >> "${TMP_INDEX}"
                echo '  text-decoration: none;' >> "${TMP_INDEX}"
                echo '  transition: all 0.3s;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.node-info a:hover {' >> "${TMP_INDEX}"
                echo '  color: var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 10px var(--neon-pink);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.last-update {' >> "${TMP_INDEX}"
                echo '  background: rgba(0, 255, 0, 0.1);' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '  border-left: 4px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '  padding: 15px;' >> "${TMP_INDEX}"
                echo '  margin: 20px 0;' >> "${TMP_INDEX}"
                echo '  font-size: 0.9em;' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '  animation: data-stream 1s ease-in-out infinite alternate;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes data-stream {' >> "${TMP_INDEX}"
                echo '  0% { box-shadow: 0 0 5px var(--neon-green); }' >> "${TMP_INDEX}"
                echo '  100% { box-shadow: 0 0 15px var(--neon-green); }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.last-update::before {' >> "${TMP_INDEX}"
                echo '  content: "> LAST_UPDATE.LOG";' >> "${TMP_INDEX}"
                echo '  position: absolute;' >> "${TMP_INDEX}"
                echo '  top: -12px;' >> "${TMP_INDEX}"
                echo '  left: 15px;' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  padding: 0 8px;' >> "${TMP_INDEX}"
                echo '  font-size: 0.7rem;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.commit-hash {' >> "${TMP_INDEX}"
                echo '  font-family: "Courier New", monospace;' >> "${TMP_INDEX}"
                echo '  background: rgba(255, 105, 180, 0.2);' >> "${TMP_INDEX}"
                echo '  color: var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  padding: 4px 8px;' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  font-size: 0.85em;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 5px var(--neon-pink);' >> "${TMP_INDEX}"
                echo '  animation: hash-flicker 2s infinite;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes hash-flicker {' >> "${TMP_INDEX}"
                echo '  0%, 100% { opacity: 1; }' >> "${TMP_INDEX}"
                echo '  50% { opacity: 0.7; }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.table-container {' >> "${TMP_INDEX}"
                echo '  overflow-x: auto;' >> "${TMP_INDEX}"
                echo '  margin: 25px 0;' >> "${TMP_INDEX}"
                echo '  border: 2px solid var(--cyber-purple);' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '  background: rgba(147, 112, 219, 0.05);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.table-container::before {' >> "${TMP_INDEX}"
                echo '  content: "> POD_MATRIX.DB";' >> "${TMP_INDEX}"
                echo '  position: absolute;' >> "${TMP_INDEX}"
                echo '  top: -12px;' >> "${TMP_INDEX}"
                echo '  left: 20px;' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  color: var(--cyber-purple);' >> "${TMP_INDEX}"
                echo '  padding: 0 10px;' >> "${TMP_INDEX}"
                echo '  font-size: 0.8rem;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table {' >> "${TMP_INDEX}"
                echo '  width: 100%;' >> "${TMP_INDEX}"
                echo '  border-collapse: collapse;' >> "${TMP_INDEX}"
                echo '  margin: 0;' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  min-width: 600px;' >> "${TMP_INDEX}"
                echo '  font-family: "Courier New", monospace;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table th {' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(135deg, var(--cyber-purple) 0%, var(--neon-pink) 100%);' >> "${TMP_INDEX}"
                echo '  color: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  padding: 15px 12px;' >> "${TMP_INDEX}"
                echo '  text-align: left;' >> "${TMP_INDEX}"
                echo '  font-weight: 700;' >> "${TMP_INDEX}"
                echo '  font-size: 0.9rem;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '  position: sticky;' >> "${TMP_INDEX}"
                echo '  top: 0;' >> "${TMP_INDEX}"
                echo '  z-index: 10;' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '  text-shadow: none;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table td {' >> "${TMP_INDEX}"
                echo '  padding: 12px;' >> "${TMP_INDEX}"
                echo '  border: 1px solid rgba(0, 255, 0, 0.3);' >> "${TMP_INDEX}"
                echo '  font-size: 0.85rem;' >> "${TMP_INDEX}"
                echo '  vertical-align: middle;' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  background: rgba(0, 0, 0, 0.8);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table tbody tr {' >> "${TMP_INDEX}"
                echo '  transition: all 0.3s ease;' >> "${TMP_INDEX}"
                echo '  position: relative;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table tbody tr:hover {' >> "${TMP_INDEX}"
                echo '  background: rgba(0, 255, 0, 0.1) !important;' >> "${TMP_INDEX}"
                echo '  transform: scale(1.002);' >> "${TMP_INDEX}"
                echo '  box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table tbody tr:nth-child(even) {' >> "${TMP_INDEX}"
                echo '  background: rgba(147, 112, 219, 0.05);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.pod-table tbody tr:nth-child(odd) {' >> "${TMP_INDEX}"
                echo '  background: rgba(255, 105, 180, 0.05);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.status-running {' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green);' >> "${TMP_INDEX}"
                echo '  font-weight: 600;' >> "${TMP_INDEX}"
                echo '  padding: 4px 8px;' >> "${TMP_INDEX}"
                echo '  background: rgba(0, 255, 0, 0.2);' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '  font-size: 0.8rem;' >> "${TMP_INDEX}"
                echo '  display: inline-block;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '  animation: status-pulse 2s infinite;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 5px var(--neon-green);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.status-pending {' >> "${TMP_INDEX}"
                echo '  color: #ffff00;' >> "${TMP_INDEX}"
                echo '  font-weight: 600;' >> "${TMP_INDEX}"
                echo '  padding: 4px 8px;' >> "${TMP_INDEX}"
                echo '  background: rgba(255, 255, 0, 0.2);' >> "${TMP_INDEX}"
                echo '  border: 1px solid #ffff00;' >> "${TMP_INDEX}"
                echo '  font-size: 0.8rem;' >> "${TMP_INDEX}"
                echo '  display: inline-block;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '  animation: status-pulse 2s infinite;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 5px #ffff00;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '.status-error {' >> "${TMP_INDEX}"
                echo '  color: #ff0040;' >> "${TMP_INDEX}"
                echo '  font-weight: 600;' >> "${TMP_INDEX}"
                echo '  padding: 4px 8px;' >> "${TMP_INDEX}"
                echo '  background: rgba(255, 0, 64, 0.2);' >> "${TMP_INDEX}"
                echo '  border: 1px solid #ff0040;' >> "${TMP_INDEX}"
                echo '  font-size: 0.8rem;' >> "${TMP_INDEX}"
                echo '  display: inline-block;' >> "${TMP_INDEX}"
                echo '  text-transform: uppercase;' >> "${TMP_INDEX}"
                echo '  letter-spacing: 1px;' >> "${TMP_INDEX}"
                echo '  animation: status-pulse 2s infinite;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 5px #ff0040;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@keyframes status-pulse {' >> "${TMP_INDEX}"
                echo '  0%, 100% { opacity: 1; }' >> "${TMP_INDEX}"
                echo '  50% { opacity: 0.7; }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Custom scrollbar */' >> "${TMP_INDEX}"
                echo '::-webkit-scrollbar {' >> "${TMP_INDEX}"
                echo '  width: 12px;' >> "${TMP_INDEX}"
                echo '  height: 12px;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '::-webkit-scrollbar-track {' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black);' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--neon-green);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '::-webkit-scrollbar-thumb {' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(45deg, var(--neon-green), var(--cyber-purple));' >> "${TMP_INDEX}"
                echo '  border: 1px solid var(--matrix-black);' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '::-webkit-scrollbar-thumb:hover {' >> "${TMP_INDEX}"
                echo '  background: linear-gradient(45deg, var(--cyber-purple), var(--neon-pink));' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Mobile responsiveness with cyberpunk flair */' >> "${TMP_INDEX}"
                echo '@media (max-width: 768px) {' >> "${TMP_INDEX}"
                echo '  body { padding: 10px; }' >> "${TMP_INDEX}"
                echo '  .container { padding: 20px; }' >> "${TMP_INDEX}"
                echo '  h1 { font-size: 1.8rem; letter-spacing: 2px; }' >> "${TMP_INDEX}"
                echo '  h3 { font-size: 1.2rem; letter-spacing: 1px; }' >> "${TMP_INDEX}"
                echo '  .node-info { padding: 20px; font-size: 0.9rem; }' >> "${TMP_INDEX}"
                echo '  .pod-table th, .pod-table td { padding: 8px 6px; font-size: 0.75rem; }' >> "${TMP_INDEX}"
                echo '  .pod-table th { font-size: 0.8rem; }' >> "${TMP_INDEX}"
                echo '  .pod-table td:first-child { word-break: break-word; max-width: 150px; }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '@media (max-width: 480px) {' >> "${TMP_INDEX}"
                echo '  .pod-table { min-width: 500px; }' >> "${TMP_INDEX}"
                echo '  .pod-table th, .pod-table td { padding: 6px 4px; font-size: 0.7rem; }' >> "${TMP_INDEX}"
                echo '  .node-info { padding: 15px; font-size: 0.85rem; }' >> "${TMP_INDEX}"
                echo '  .last-update { padding: 12px; font-size: 0.8rem; }' >> "${TMP_INDEX}"
                echo '  h1 { font-size: 1.5rem; letter-spacing: 1px; }' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Matrix rain effect for background */' >> "${TMP_INDEX}"
                echo '.container::after {' >> "${TMP_INDEX}"
                echo '  content: "";' >> "${TMP_INDEX}"
                echo '  position: absolute;' >> "${TMP_INDEX}"
                echo '  top: 0;' >> "${TMP_INDEX}"
                echo '  left: 0;' >> "${TMP_INDEX}"
                echo '  right: 0;' >> "${TMP_INDEX}"
                echo '  bottom: 0;' >> "${TMP_INDEX}"
                echo '  background-image:' >> "${TMP_INDEX}"
                echo '    radial-gradient(circle at 20% 80%, rgba(0, 255, 0, 0.1) 0%, transparent 50%),' >> "${TMP_INDEX}"
                echo '    radial-gradient(circle at 80% 20%, rgba(255, 105, 180, 0.1) 0%, transparent 50%),' >> "${TMP_INDEX}"
                echo '    radial-gradient(circle at 40% 40%, rgba(147, 112, 219, 0.1) 0%, transparent 50%);' >> "${TMP_INDEX}"
                echo '  pointer-events: none;' >> "${TMP_INDEX}"
                echo '  z-index: -1;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Footer styling to match cyberpunk theme */' >> "${TMP_INDEX}"
                echo 'footer, .footer, #footer, .site-footer {' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black) !important;' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green) !important;' >> "${TMP_INDEX}"
                echo '  border-top: 2px solid var(--neon-green) !important;' >> "${TMP_INDEX}"
                echo '  padding: 20px !important;' >> "${TMP_INDEX}"
                echo '  font-family: "Courier New", monospace !important;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo 'footer a, .footer a, #footer a, .site-footer a {' >> "${TMP_INDEX}"
                echo '  color: var(--cyber-blue) !important;' >> "${TMP_INDEX}"
                echo '  text-decoration: none !important;' >> "${TMP_INDEX}"
                echo '  transition: all 0.3s !important;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo 'footer a:hover, .footer a:hover, #footer a:hover, .site-footer a:hover {' >> "${TMP_INDEX}"
                echo '  color: var(--neon-pink) !important;' >> "${TMP_INDEX}"
                echo '  text-shadow: 0 0 10px var(--neon-pink) !important;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Ensure any white backgrounds are overridden */' >> "${TMP_INDEX}"
                echo '.content-wrapper, .main-content, .page-content {' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black) !important;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '' >> "${TMP_INDEX}"
                echo '/* Override any default theme footer styling */' >> "${TMP_INDEX}"
                echo 'body > footer,' >> "${TMP_INDEX}"
                echo 'body > .footer,' >> "${TMP_INDEX}"
                echo '.hugo-footer,' >> "${TMP_INDEX}"
                echo '.theme-footer {' >> "${TMP_INDEX}"
                echo '  background: var(--matrix-black) !important;' >> "${TMP_INDEX}"
                echo '  color: var(--neon-green) !important;' >> "${TMP_INDEX}"
                echo '  border-top: 2px solid var(--neon-green) !important;' >> "${TMP_INDEX}"
                echo '}' >> "${TMP_INDEX}"
                echo '</style>' >> "${TMP_INDEX}"
                
                # Replace the original file with our clean version
                cp "${TMP_INDEX}" content/_index.md
                
                # Clean up the temp file
                rm -f "${TMP_INDEX}"
              else
                # Error: _index.md file doesn't exist - this should not happen in normal operation
                echo "ERROR: content/_index.md file not found. This cronjob requires an existing _index.md file to update." >&2
                exit 1
              fi
              
              # Create JSON API with proper formatting
              echo "{" > static/api/cluster-status.json
              echo "  \"statistics\": {" >> static/api/cluster-status.json
              echo "    \"totalPods\": ${TOTAL_PODS}," >> static/api/cluster-status.json
              echo "    \"runningPods\": ${RUNNING_PODS}" >> static/api/cluster-status.json
              echo "  }" >> static/api/cluster-status.json
              echo "}" >> static/api/cluster-status.json
              
              # Stage all content updates
              echo "Staging content updates..."
              git add -A
              
              # Check if there are changes to commit
              if git diff --staged --quiet; then
                echo "No changes to commit"
              else
                echo "Committing content updates..."
                git commit -m "Automatic update of pod status at $(date -u)"
                
                # Update image tag in values.yaml
                if [ -f "charts/hugo-site/values.yaml" ]; then
                  echo "Updating values.yaml first to ensure correct tag reference..."
                  
                  # Create a temporary unique tag to update later
                  TEMP_TAG="temp-tag-$(date +%s)"
                  
                  # Update the values.yaml file with the temporary tag
                  sed "s/^  tag:.*$/  tag: $TEMP_TAG/" charts/hugo-site/values.yaml > /tmp/new_values.yaml
                  mv /tmp/new_values.yaml charts/hugo-site/values.yaml
                  
                  # Commit the temporary values.yaml change
                  git add charts/hugo-site/values.yaml
                  git commit -m "Temporary tag update for values.yaml"
                  
                  # Now get the final commit SHA - this will be the one GitHub Actions uses
                  FINAL_COMMIT_SHA=$(git rev-parse HEAD)
                  echo "Final commit SHA: ${FINAL_COMMIT_SHA}"
                  
                  # Update the git commit hash in the _index.md file if the element exists
                  if grep -q "id=\"git-commit-hash\"" content/_index.md; then
                    HASH_SHORT="${FINAL_COMMIT_SHA:0:7}"
                    sed "s/<span class=\"commit-hash\" id=\"git-commit-hash\">[^<]*<\/span>/<span class=\"commit-hash\" id=\"git-commit-hash\">$HASH_SHORT<\/span>/g" content/_index.md > /tmp/new_index.md
                    mv /tmp/new_index.md content/_index.md
                    git add content/_index.md
                  fi
                  
                  # Now update with the final SHA that GitHub Actions will use
                  sed "s/^  tag:.*$/  tag: $FINAL_COMMIT_SHA/" charts/hugo-site/values.yaml > /tmp/new_values.yaml
                  mv /tmp/new_values.yaml charts/hugo-site/values.yaml
                  
                  # Amend the commit to include the final SHA reference
                  git add charts/hugo-site/values.yaml
                  git commit --amend -m "Update image tag to match final commit SHA: ${FINAL_COMMIT_SHA}"
                  
                  echo "Values.yaml updated with final commit SHA: ${FINAL_COMMIT_SHA}"
                fi
                
                # Push all changes to repository
                echo "Pushing changes to repository..."
                git remote set-url origin "https://${GIT_USERNAME}:${GITHUB_TOKEN}@github.com/zoonderkins/edoo-k8s-demo-site.git"
                git push origin master --force
                echo "All changes pushed successfully"
                
                # Trigger ArgoCD sync after GitHub Actions has time to build
                echo "Waiting for GitHub Actions to build and push the new image (5 minutes)..."
                sleep 300
                
                echo "Triggering ArgoCD sync..."
                if command -v kubectl &> /dev/null; then
                  # Patch ArgoCD application to force sync
                  kubectl -n argocd patch application hugo-k8s-dashboard -p '{"spec":{"syncPolicy":{"automated":{"prune":true,"selfHeal":true}}}}' --type=merge || echo "Failed to patch via kubectl"
                  kubectl -n argocd patch application hugo-k8s-dashboard --type=json -p='[{"op": "replace", "path": "/metadata/annotations/argocd.argoproj.io~1sync-options", "value":"Force=true"}]' || echo "Failed to force sync via kubectl"
                  echo "ArgoCD sync triggered"
                else
                  echo "kubectl not available, skipping manual sync"
                fi
              fi
              
              echo "Pod information update process completed successfully"
          restartPolicy: OnFailure
          serviceAccountName: github-push
